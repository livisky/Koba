define("business/cart/0.0.1/cart",[],function(){function a(){if($("goodsbody")){var a=new Element("div",{styles:{position:"absolute",zIndex:500,opacity:0,border:"1px #666 solid",background:"#fff"}}).inject(document.body),b=function(b,c){if(b){a.empty().adopt($(b).clone().removeProperties("width","height").setStyle("border","1px #fff solid")).fade(1);var d=window.getSize(),e=window.getScroll(),f={x:a.offsetWidth,y:a.offsetHeight},g={x:"left",y:"top"};for(var h in g){var i=c.page[h]+10;i+f[h]-e[h]>d[h]&&(i=c.page[h]-10-f[h]),a.setStyle(g[h],i)}}};$$("#cart-index .cart-product-img").each(function(c){new Asset.image(c.get("isrc"),{onload:function(d){if(d){var e=d;e&&(e.setStyle("cursor","pointer").addEvents({mouseenter:function(a){b(e,a)},mouseleave:function(){a.fade(0)}}),c.empty().adopt(new Element("a",{href:c.get("ghref"),target:"_blank",styles:{border:0}}).adopt(e)))}},onerror:function(){c.empty()}})})}}function b(){jQuery("#goodsbody").find("tbody tr").each(function(){var a,b,c=jQuery(this).find(".Numinput input").val();if(jQuery(this).hasClass("adjunct_item")){b=jQuery(this).attr("min_num");var d=jQuery(this).attr("basic_number"),e=jQuery("#goodsbody").find("tr[chlid_id= "+jQuery(this).attr("class").split(" ")[0]+"]").find("input[name^=modify_quantity]").val(),f=d*e,g=parseInt(jQuery(this).attr("number"));a=f-g>=0?f:g}else a=parseInt(jQuery(this).attr("number")),b=1;1==a?(jQuery(this).find(".numadjust.decrease").addClass("crisis"),jQuery(this).find(".numadjust.increase").addClass("crisis")):c==b?jQuery(this).find(".numadjust.decrease").addClass("crisis"):c>b&&a>c?(jQuery(this).find(".numadjust.decrease").removeClass("crisis"),jQuery(this).find(".numadjust.increase").removeClass("crisis")):c==a&&jQuery(this).find(".numadjust.increase").addClass("crisis")})}window.addEvent("domready",function(){a(),b()}),void function(){$("cartitems"),Cart={},Cart.utility={keyCodeFix:[48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105,8,9,46,37,39],accAdd:function(a,b){var c,d,e;try{c=a.toString().split(".")[1].length}catch(f){c=0}try{d=b.toString().split(".")[1].length}catch(f){d=0}return e=Math.pow(10,Math.max(c,d)),(a*e+b*e)/e},moneyFormat:{rule:myrule,format:function(a){var b=this.rule;a=a.toFloat(),a=a.round(b.decimals)+"";var c=a.indexOf(".");for(0>c?(c=a.length,part=""):part=a.substr(c+1);part.length<b.decimals;)part+="0";for(var d=[];c>0;){if(!(c>2)){d.unshift(a.substr(0,c));break}d.unshift(a.substr(c-=3,3))}return b.sign+d.join(b.thousands_sep)+b.dec_point+part}}},Object.append(Cart,{removeItem:function(a){var b="",c=$(a).getParent("tr");b=c.hasClass("havechild")&&c.hasClass("adjunctItem")?"你确定要删除该搭配的所有商品吗？":"你确定要删除该商品吗？",Ex_Dialog.confirm(b,function(b){if(b){var c=$(a).getParent("tr"),d=c.get("urlremove"),e=c.getElement("div.Numinput").toQueryString();if(c.hasClass("havechild")){var f=c.get("chlid_id");(group=c.getParent("table").getElements("."+f))&&group.each(function(a){a.getElements("input").set("disabled",!0)})}var g=this;this.updateTotal(d,{data:e+"&response_type=true",onRequest:function(){Browser.ie6||(c.getElements("td")[1].set("html","正在删除..."),c.setStyles({background:"#FBE3E4",opacity:1}))},onComplete:function(a){var b=JSON.decode(a);if("true"===b.is_empty){var d='<div class="division cart-empty" id="goodsbody"><div class="w400 ma clearfix"><img src='+myres_url+' class="flt m5"/>     <p class="pt10">您的购物车里还没有商品,您可以：<br />将收藏夹中的商品添加进来<br />或者去看看&nbsp;<a href="/product-mall.html" class="font-orange">萤石商城>></a></p></div></div>';$("cart-index").set("html",d)}else if(b.error)Ex_Dialog.alert(b.error,"");else{if(c.hasClass("havechild")){var e=c.get("chlid_id");(group=c.getParent("table").getElements("."+e))&&group.each(function(a){a.destroy()})}c.destroy();var f=jQuery("#goodsbody tbody"),h=f.find("tr.havechild");if(0==h.length){var i=$$(".order_rule_id"),j=$$("tr[order_rule_id]");j.length&&j.each(function(a){if(!i.length)return a.destroy();var b=i.some(function(b){return a.get("order_rule_id").split(",").contains(b.value)?!0:void 0});b||a.destroy()})}g.updateActivity(b.suitable_active),g.updateCoupons(b.used_coupons),g.updateTotalPrice(b.sub_total),g.updateRecommendData(b.recommend_data),g.updateWillGetPromotion(b.unuse_rule)}$("goodsbody").getElement("tbody")&&""==$("goodsbody").getElement("tbody").get("html").trim()&&$("goodsbody").destroy();var k=Cookie.read("S[CART_COUNT]")||0;g.updateWidgetsCartNum(b.number),$$(".cart-number").set("text",k),$$(".minicart-title .num")&&$$(".minicart-title .num").set("text",k),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0),"0"===k.toString()?$$(".minicart_box").removeClass("has-pro"):$$(".minicart_box").addClass("has-pro")}})}}.bind(this))},addItem:function(b,c){var d=myaddurl;d=d.replace(/(_goods_id)/g,b),d=0!=c?d.replace(/(_product_id)/g,c):d.replace(/(-_product_id)/g,"");var e=this;e.updateTotal(d,{onComplete:function(b){if(JSON.validate(b)){var c=JSON.decode(b);Ex_Dialog.alert(c.error,"")}else $("cart-items-detail").set("html",b);a(),e.updateOtherDatas()}})},updateOtherDatas:function(){var a=mygetDataUrl,b=this;b.updateTotal(a,{onComplete:function(a){var c=JSON.decode(a);b.updateActivity(c.suitable_active),b.updateCoupons(c.used_coupons),b.updateTotalPrice(c.sub_total),b.updateRecommendData(c.recommend_data),b.updateWillGetPromotion(c.unuse_rule),b.updateWidgetsCartNum(c.number),$$(".cart-number").set("text",Cookie.read("S[CART_COUNT]")||0),$$(".minicart-title .num")&&$$(".minicart-title .num").set("text",Cookie.read("S[CART_COUNT]")||0),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0)}})},removeDecreaseCrisis:function(a){a.getParent(".Numinput").getElements(".numadjust.decrease").removeClass("crisis")},removeIncreaseCrisis:function(a){a.getParent(".Numinput").getElements(".numadjust.increase").removeClass("crisis")},addDecreaseCrisis:function(a){a.getParent(".Numinput").getElements(".numadjust.decrease").addClass("crisis")},addIncreaseCrisis:function(a){a.getParent(".Numinput").getElements(".numadjust.increase").addClass("crisis")},CheckNum:function(a,b,c,d){1==c?(Cart.addDecreaseCrisis(a),Cart.addIncreaseCrisis(a)):2==c?1==b?(Cart.addDecreaseCrisis(a),Cart.removeIncreaseCrisis(a)):2==b&&(Cart.removeDecreaseCrisis(a),Cart.addIncreaseCrisis(a)):b==d?Cart.addDecreaseCrisis(a):b>d&&c>b?(Cart.removeDecreaseCrisis(a),Cart.removeIncreaseCrisis(a)):b==c&&Cart.addIncreaseCrisis(a)},ItemNumUpdate:function(a,b,c,d){if(a){b=b||a.value;var e=a.getParent("tr").get("floatstore"),f=["toInt","toFloat"],g=a.value[f[e]]();c&&new Event(c).target!=a&&(g=(isNaN(g)?1:g)+b),g[f[e]]()<=0&&(g=1),a.value=g.limit(0,Number.MAX_VALUE);var h=a.getParent("tr").getAttribute("goods-id"),i=0,j=0;$$("tr[goods-id="+h+"]").each(function(a){j=parseInt(a.getElementsByTagName("input")[0].value),i+=isNaN(j)?1:j});var k=a.getParent("tr").getAttribute("number")[f[e]](),l=a.getParent("tr").getAttribute("g_number");if(g>k)return null!=l&&"no_num"!=l&&l[f[e]]()>0&&l[f[e]]()<k&&(k=l[f[e]]()),a.value=k,this.updateItem(c,a,a.getParent("tr"),d),this.__forUpNum=g,void(this.__goods_number=k);var m=a.getParent("tr").getAttribute("min_num");if(null!=m&&g<m[f[e]]())return a.value=m,this.updateItem(c,a,a.getParent("tr"),d),this.__forUpNum=g,void(this.__goods_number=k);if(null!=l&&("no_num"==l||0!=l&&i>l[f[e]]())&&(a.value=l,"no_num"==l&&(l=0)),a.getParent("tr").hasClass("adjunctItem")){var n,o=handle_num=0;$$(".adjunct_item,"+a.getParent("tr").getAttribute("goods-id")).length,$$(".adjunct_item,"+a.getParent("tr").getAttribute("goods-id")).each(function(b){n=b.getAttribute("basic_number")[f[e]](),b.setAttribute("number",n*a.value);var g=b,h=g.getElement("input"),i=parseInt(h.getValue()[0]),j=g.getAttribute("number"),k=1;if(Cart.CheckNum(h,i,j,k),b.getElement("input[name^=modify_quantity]").value>n*a.value){b.getElement("input[name^=modify_quantity]").value=n*a.value,o++;var l=b.getElement("input[name^=modify_quantity]"),m=l.getParent("tr").toQueryString();b.store("request",new Request({url:b.get("urlupdate"),data:m+"&response_type=true",method:"post",onSuccess:function(b){handle_num++;var e=JSON.decode(b);e&&e.success?(this.updateActivity(e.suitable_active),this.updateCoupons(e.used_coupons),Cart.updateTotalPrice(e.sub_total),Cart.updateWillGetPromotion(e.unuse_rule),Cart.updateNum(l,e.edit_ajax_data,e.error_msg),Cart.updateWidgetsCartNum(e.number)):Ex_Dialog.alert(e.error,""),0!=handle_num&&handle_num==o&&Cart.updateItem(c,a,a.getParent("tr"),d),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0)}.bind(Cart),onFailure:function(){l.focus()}.bind(Cart)}).send())}})}(!a.getParent("tr").hasClass("adjunctItem")||0>=o)&&this.updateItem(c,a,a.getParent("tr"),d),this.__forUpNum=g,this.__goods_number=k}},updateItem:function(a,b,c,d){if(!d){var e,f,g=b.value.toInt();if(-1==c.className.indexOf("adjunct_item"))f=c.getAttribute("number").toInt(),e=1;else if(c.className.indexOf("adjunct_item")>=0){e=c.getAttribute("min_num");var h=c.getAttribute("basic_number").toInt(),i=$("goodsbody").getElement("tr[chlid_id= "+c.className.split(" ")[0]+"]").getElement("input[name^=modify_quantity]").value.toInt(),j=h*i,k=c.getAttribute("number").toInt();f=j-k>=0?j:k}if("NaN"==b.value)return b.value=1,!1;var l=b.getParent("tr").toQueryString(),m=a.target?a.target:a.srcElement;m.hasClass("crisis")&&m.hasClass("crisis")||c.store("request",new Request({url:c.get("urlupdate"),data:l+"&response_type=true",method:"post",onSuccess:function(a){var c=JSON.decode(a);c&&c.success?(this.updateActivity(c.suitable_active),this.updateCoupons(c.used_coupons),this.updateTotalPrice(c.sub_total),this.updateWillGetPromotion(c.unuse_rule),this.updateNum(b,c.edit_ajax_data,c.error_msg),this.updateWidgetsCartNum(c.number)):Ex_Dialog.alert(c.error,""),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0)}.bind(this),onFailure:function(){b.focus()}.bind(this)}).send()),Cart.CheckNum(b,g,f,e)}},updateActivity:function(a){var b=jQuery(".activity");if(0!=a.length&&0!=a){if(b.show(),0==jQuery(".activity #content").length){var c=jQuery('<td class="left">活动：</td><td id="content"></td>');b.append(c)}else{var c=jQuery(".activity #content");c.empty()}for(var c=jQuery(".activity #content"),d=0;d<a.length;d++){var e=jQuery('<div class="center"></div>'),f=jQuery('<div class="right"></div>');e.html(a[d].name),f.html(0==a[d].discount_amount?"":"-￥"+a[d].discount_amount),c.append(e,f)}}else b.hide()},updateCoupons:function(a){var b=jQuery(".coupon");if(0==a)b.hide();else{if(b.show(),0==jQuery(".coupon #content").length){var c=jQuery('<td class="left">已选优惠券：</td><td id="content"></td>');b.append(c)}else{var c=jQuery(".coupon #content");c.empty()}var c=jQuery(".coupon #content");for(var d in a){var e=a[d],f=e.name,g=e.discount_amount,h=jQuery('<div class="center"></div>'),i=jQuery('<div class="right"></div>');h.html(f),i.html("-￥"+g),c.append(h,i)}}},updateTotalPrice:function(a){var b=a.promotion_subtotal,c=a.discount_amount_order,d=jQuery(".total-fav"),e=jQuery("#cart-promotion-subtotal");if(jQuery(".total-price"),e.html(b),0!=c){if(d.show(),0==jQuery("#cart-promotion_discount_price").length){var f=jQuery('<td class="left">合计优惠：</td><td class="right" id="cart-promotion_discount_price"></td>');d.append(f)}else{var g=jQuery("#cart-promotion_discount_price");g.empty()}var g=jQuery("#cart-promotion_discount_price");g.html(c)}else d.hide()},updateWidgetsCartNum:function(a){$$(".cart-count")?$$(".cart-count").set("html",a.cart_count?a.cart_count:0):$$(".cart-number")&&$$(".cart-number").set("html",a.cart_number?a.cart_number:0)},updateWillGetPromotion:function(a){if(a){var b=$("cart-will-get-sales-promotion"),c="";a.each(function(a){c+='<tr><td class="span-2">'+a.name+'</td><td class="span-6" style="text-align:left">'+a.desc+'</td><td class="span-6" style="text-align:left">'+a.solution+"</td></tr>"});var d=' <h4>赶快行动得促销优惠</h4><table width="100%" cellpadding="3" cellspacing="0">{_unuse_rule_html}</table>';d=d.substitute({_unuse_rule_html:c}),b?b.set("html",d):(b=new Element("div",{id:"cart-will-get-sales-promotion","class":"sales-promotion clearfix",html:d}),b.inject($("cart-return-btn"),"after"))}else{var b=$("cart-will-get-sales-promotion");b&&b.destroy()}},updateRecommendData:function(a){if(a){var b=$("cart-recommend—data"),c="";a.each(function(a){c+='<li class="recommendGood">',c+='        <p class="img"><a href='+mylink1+' target="_blank"><img src="'+a.img_src+'"></a></p>',c+='        <p class="title"><a href='+mylink2+' target="_blank">'+a.name+"</a></p>",c+='        <p class="price">￥'+a.price+"</p>",c+='        <p class="addCartBtn itemsList" product="'+a.goods_id+'">',c+=a.product_num>1?'        <a class="hasSpec repos" type="g" target="_dialog_minicart" title="加入购物车" rel="nofollow">加入购物车</a>':'        <a class="addItem" type="g" title="加入购物车" rel="nofollow" >加入购物车</a>',c+="        </p>",c+="</li>",c=c.replace(/(index-_goods_id)/g,a.goods_id)});var d="";d+='<div class="recommendTitleCon">',d+='    <div class="recommendTitle">也许您还需要</div>',d+="</div>",d+='<div class="recommendContainer">',d+='    <ul class="recommendGoods">',d+="{_recommend_data_html}",d+="    </ul>",d+="</div>",d=d.substitute({_recommend_data_html:c}),b?b.set("html",d):(b=new Element("div",{id:"cart-recommend—data","class":"sales-promotion clearfix",html:d}),b.inject($("cart-return-btn"),"after"))}else{var b=$("cart-recommend—data");b&&b.destroy()}specdialog()},updatePromotion:function(a){var b=$("cart-real-sales-promotion");if(a&&a.order){var c=a.order,d="<h4>已享受的促销优惠</h4><ul>",e=new Object;Object.each(c,function(a){e={rule_id:a.rule_id,name:a.name,solution:a.solution},d+='<li class="clearfix p10"><span class="w300 fl"><input type="hidden" class="order_rule_id" value="{rule_id}" />{name}</span><span class="w400 fl ml10">{solution}</span></li>'.substitute(e)}),d+="</ul>",b?b.set("html",d):(b=new Element("div",{id:"cart-real-sales-promotion","class":"sales-promotion",html:d}),b.inject($("btn-cart-del-area"),"after"))}else b&&b.destroy()},updateNum:function(a,b,c){b=JSON.decode(b),"undefined"!=typeof c&&""!=c&&(a.value=b.quantity,Ex_Dialog.alert(c,""));var d=a.getParent("tr");a.getElements(".t"),d.set("buy_store",a.value),["buy_price","consume_score"].each(function(a){var c=d.getElement("."+a);c&&c.set("text",b[a])})},updateTotal:function(a,b){b=b||{},new Request(Object.append({method:"post",url:a},b)).send(),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0)},empty:function(a){var b=this;Ex_Dialog.confirm("确认清空购物车？",function(c){c&&new Request({url:a,data:"response_type=true",onComplete:function(a){var c=JSON.decode(a);if(c&&c.error)Ex_Dialog.alert(c.error,"");else{var d="清空购物车成功！";"true"!==c.is_empty&&(d="清空购物车成功（保留赠品）！"),Message.success(d,function(){b.updateWidgetsCartNum(c.number),$$(".cart-number").set("text",Cookie.read("S[CART_COUNT]")||0),$$(".minicart-title .num")&&$$(".minicart-title .num").set("text",Cookie.read("S[CART_COUNT]")||0),$$(".cart-money-total")&&$$(".cart-money-total").set("text",Cookie.read("S[CART_TOTAL_PRICE]")||0);var a=Cookie.read("S[CART_COUNT]")||0;if("0"===a.toString()?$$(".minicart_box").removeClass("has-pro"):$$(".minicart_box").addClass("has-pro"),"true"!==c.is_empty)location.reload();else{var d='<div class="division cart-empty" id="goodsbody"><div class="w400 ma clearfix"><img src="'+RES_URL+'/bundle/empty_pic.gif" class="flt m5"/>     <p class="pt10">您的购物车里还没有商品,您可以：<br />将收藏夹中的商品添加进来<br />或者去看看&nbsp;<a href="/product-mall.html" class="font-orange">萤石商城>></a></p></div></div>';$("cart-index").set("html",d)}})}}}).post()})}}),$("cart-items")&&$("form-cart").getLast("div").addEvents({mousedown:function(a){var b=$(a.target);if(b.hasClass("numadjust"))b.addClass("active");else if(b.hasClass("order-btn")||b.getParent(".order-btn")){var c=$$("input[name^=modify_quantity[]:focus")[0];c&&c.removeEvents("change").addEvent("change",function(a){Cart.ItemNumUpdate(this,this.value,a,!0)})}},mouseup:function(a){var b=$(a.target);b.hasClass("numadjust")&&b.removeClass("active")},keydown:function(a){var b=$(a.target);b.hasClass("textcenter")&&(1==b.getParent("tr").getAttribute("floatstore").toInt()&&(110==a.code||190==a.code)&&(a.code=48),Cart.utility.keyCodeFix.contains(a.code)||a.stop())},click:function(a){var b=$(a.target);if(b.hasClass("numadjust")){var c=b.hasClass("increase")?1:-1,d=b.getParent(".numadjust-arr").getPrevious("input");if(-1==c&&d.value<1)return;return Cart.ItemNumUpdate(d,c,a)}if(b.hasClass("delItem")&&Cart.removeItem(b),b.hasClass("addItem")){Cart.addItem(b.getParent("p").get("product"),0);var e=b.getParent("li");Browser.ie6||(e.set("html","正在加入购物车..."),e.setStyles({background:"#E4F4E4",opacity:1}))}}}),$$(".btn_e.btn_e3.fr").removeEvents("click").addEvent("click",function(a){var b=0,c=0,d=0,e="",f=0;$$("input[name^=modify_quantity]").each(function(a){d=parseInt(a.value),b=parseInt(a.getParent("tr").getAttribute("number")),c=a.getParent("tr").getAttribute("g_number"),(d>b||"no_num"==c||0!=c&&d>parseInt(c))&&(a.value=b>parseInt(c)?parseInt(c):b,e=a.getParent("tr").getAttribute("g_name"))}),""!=e&&(f=parseInt(c)>0&&b>c?c:b,Ex_Dialog.alert(""+e+"：累计购买数量超出每人限购数量<br/>（可购买数量为："+f+"）",""));var g=$$(".numadjust-arr").getPrevious("input");Cart.updateItem(a,g,g.getParent("tr"),"abort")})}()});